<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NutriLens - Shopping Cart</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <nav>
    <div class="logo-title">
      <a href="/"><img src="/static/img/logo.png" alt="Logo" /></a>
      <a href="/"><strong>NutriLens</strong></a>
    </div>
    <div>
      <a href="/">About</a>
      <a href="/">Login</a>
      <button class="sign-in-btn" onclick="location.href='/'">Sign In</button>
    </div>
  </nav>

  <div class="hero">
    <div class="hero-content">
      <h1>Your Shopping Cart</h1>
      <p>Manage your ingredients and shopping list with ease</p>
    </div>
  </div>

  <h2 class="section-title">üõí Shopping Cart</h2>

  <div class="card">
    <h5 class="card-title">Add New Item</h5>
    <div class="add-item-section">
      <input type="text" id="newItemInput" placeholder="Enter item name (e.g., Tomatoes, Onions, Rice)" />
      <button class="btn" onclick="addNewItem()">Add Item</button>
    </div>
  </div>

  <div class="cart-container">
    <div id="cartMessage" class="message"></div>
    <div id="cartContent">
      <div class="loading">Loading cart...</div>
    </div>
    
    <div id="cartSummary" class="cart-summary" style="display: none;">
      <strong>Total Items: <span id="totalItems">0</span></strong>
      <br><br>
      <div id="normalButtons">
        <button class="btn" onclick="clearCart()">Clear All Items</button>
        <button class="btn" onclick="enterEditMode()">Edit Items</button>
        <button class="btn" onclick="copyItems()">Copy Items</button>
      </div>
      <div id="editButtons" style="display: none;">
        <button class="btn" onclick="saveAllChanges()">Save Changes</button>
        <button class="btn" onclick="cancelEdit()">Cancel</button>
      </div>
    </div>
  </div>

  <div class="about-section">
    <h2>About Us</h2>
    <p>
      NutriLens is an AI-driven health platform that combines food recognition, nutrition science, and personal wellness.
      We aim to empower people with informed dietary choices through smart automation and user-friendly tools.
    </p>
    <br />
    <a class="btn-about" href="/">Read More</a>
  </div>

  <footer>
    Made with ‚ù§Ô∏è by Team NutriLens
  </footer>

  <script>
    let cartData = [];
    let editingItems = new Set();

    document.addEventListener('DOMContentLoaded', function() {
      loadCart();
    });

    function showMessage(message, type = 'success') {
      const messageDiv = document.getElementById('cartMessage');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      messageDiv.style.display = 'block';
      
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 3000);
    }

    async function loadCart() {
      try {
        const response = await fetch('/get_cart');
        if (response.ok) {
          const data = await response.json();
          cartData = data.cart || [];
          displayCart();
        } else {
          showMessage('Failed to load cart', 'error');
        }
      } catch (error) {
        console.error('Error loading cart:', error);
        showMessage('Error loading cart', 'error');
      }
    }

    function displayCart() {
      const cartContent = document.getElementById('cartContent');
      const cartSummary = document.getElementById('cartSummary');
      const totalItems = document.getElementById('totalItems');

      if (cartData.length === 0) {
        cartContent.innerHTML = `
          <div class="empty-cart">
            üõí Your cart is empty!<br>
            <small>Add items from recipes or manually add ingredients</small>
          </div>
        `;
        cartSummary.style.display = 'none';
        return;
      }

      let html = '';
      cartData.forEach((item, index) => {
        const isEditing = editingItems.has(index);
        const nameDisplay = isEditing ? 
          `<input type="text" class="item-name-input" value="${item.name}" id="name-${index}" />` :
          `<div class="item-name">${item.name}</div>`;
        
        html += `
          <div class="cart-item">
            <div class="item-info">
              ${nameDisplay}
            </div>
            <div class="item-controls">
              <label>Qty:</label>
              <input type="text" class="quantity-input" 
                     value="${item.quantity || ''}"
                     placeholder=""
                     id="qty-${index}"
                     onchange="updateQuantity(${index}, this.value)">
              <button class="btn-remove" onclick="removeItem(${index})" title="Remove item">√ó</button>
            </div>
          </div>
        `;
      });

      cartContent.innerHTML = html;
      totalItems.textContent = cartData.length;
      cartSummary.style.display = 'block';
    }

    function enterEditMode() {
      editingItems.clear();
      for (let i = 0; i < cartData.length; i++) {
        editingItems.add(i);
      }
      document.getElementById('normalButtons').style.display = 'none';
      document.getElementById('editButtons').style.display = 'block';
      displayCart();
    }

    function cancelEdit() {
      editingItems.clear();
      document.getElementById('normalButtons').style.display = 'block';
      document.getElementById('editButtons').style.display = 'none';
      loadCart(); // Reload original data
    }

    async function saveAllChanges() {
      const updatedCart = [];
      
      for (let i = 0; i < cartData.length; i++) {
        const nameInput = document.getElementById(`name-${i}`);
        const qtyInput = document.getElementById(`qty-${i}`);
        
        if (nameInput && qtyInput) {
          updatedCart.push({
            ...cartData[i],
            name: nameInput.value.trim(),
            quantity: qtyInput.value.trim()
          });
        } else {
          updatedCart.push(cartData[i]);
        }
      }

      try {
        // Update cart data locally first
        cartData = updatedCart;
        
        editingItems.clear();
        document.getElementById('normalButtons').style.display = 'block';
        document.getElementById('editButtons').style.display = 'none';
        
        showMessage('Changes saved successfully!');
        displayCart();
        
        // You can add a backend sync here if needed
        // await syncCartToBackend(cartData);
        
      } catch (error) {
        console.error('Error saving changes:', error);
        showMessage('Error saving changes', 'error');
      }
    }

    async function addNewItem() {
      const input = document.getElementById('newItemInput');
      const itemName = input.value.trim();

      if (!itemName) {
        alert('Please enter an item name');
        return;
      }

      try {
        const response = await fetch('/add_item_to_cart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            item_name: itemName
          })
        });

        if (response.ok) {
          input.value = '';
          showMessage(`${itemName} added to cart!`);
          loadCart();
        } else {
          const data = await response.json();
          showMessage(data.error || 'Failed to add item', 'error');
        }
      } catch (error) {
        console.error('Error adding item:', error);
        showMessage('Error adding item', 'error');
      }
    }

    async function updateQuantity(index, newQuantity) {
      if (editingItems.has(index)) {
        // In edit mode, just update locally
        cartData[index].quantity = newQuantity.trim();
        return;
      }

      try {
        const response = await fetch('/update_item_quantity', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            item_index: index,
            quantity: newQuantity.trim()
          })
        });

        if (response.ok) {
          loadCart();
        } else {
          const data = await response.json();
          showMessage(data.error || 'Failed to update quantity', 'error');
          loadCart();
        }
      } catch (error) {
        console.error('Error updating quantity:', error);
        showMessage('Error updating quantity', 'error');
        loadCart();
      }
    }

    async function removeItem(index) {
      const itemName = cartData[index]?.name || 'item';
      
      try {
        const response = await fetch('/remove_item_from_cart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            item_index: index
          })
        });

        if (response.ok) {
          showMessage(`${itemName} removed from cart`);
          loadCart();
        } else {
          const data = await response.json();
          showMessage(data.error || 'Failed to remove item', 'error');
        }
      } catch (error) {
        console.error('Error removing item:', error);
        showMessage('Error removing item', 'error');
      }
    }

    async function clearCart() {
      if (!confirm('Are you sure you want to clear all items from your cart?')) {
        return;
      }

      try {
        const response = await fetch('/clear_cart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          showMessage('Cart cleared successfully');
          loadCart();
        } else {
          const data = await response.json();
          showMessage(data.error || 'Failed to clear cart', 'error');
        }
      } catch (error) {
        console.error('Error clearing cart:', error);
        showMessage('Error clearing cart', 'error');
      }
    }

    function copyItems() {
      if (cartData.length === 0) {
        alert('Cart is empty. Nothing to copy!');
        return;
      }

      let itemsList = cartData.map(item => {
        const qty = item.quantity && item.quantity.trim() ? item.quantity : '(no quantity specified)';
        return `${item.name} - ${qty}`;
      }).join('\n');

      const finalList = `Shopping List:\n${'-'.repeat(20)}\n${itemsList}`;

      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(finalList).then(() => {
          showMessage('Shopping list copied to clipboard!');
        }).catch(() => {
          fallbackCopyTextToClipboard(finalList);
        });
      } else {
        fallbackCopyTextToClipboard(finalList);
      }
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.top = "0";
      textArea.style.left = "0";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        showMessage('Shopping list copied to clipboard!');
      } catch (err) {
        alert('Failed to copy. Please copy manually:\n\n' + text);
      }
      
      document.body.removeChild(textArea);
    }

    document.getElementById('newItemInput').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        addNewItem();
      }
    });

    document.getElementById('newItemInput').addEventListener('input', function(event) {
      let value = event.target.value;
      event.target.value = value.charAt(0).toUpperCase() + value.slice(1);
    });
  </script>
</body>
</html>