<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NutriLens - Personalized Diet Plan</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body class="diet-plan-page">
  <nav>
    <div class="logo-title">
      <a href="/"><img src="/static/img/logo.png" alt="Logo" /></a>
      <a href="/"><strong>NutriLens</strong></a>
    </div>
    <div>
      <a href="/">About</a>
      <a href="/">Login</a>
      <button class="sign-in-btn" onclick="location.href='/'">Sign In</button>
    </div>
  </nav>

  <div class="hero">
    <div class="hero-content">
      <h1>Personalized Diet Plans</h1>
      <p>Get customized meal plans tailored to your body, lifestyle, and health goals</p>
    </div>
  </div>

  <h2 class="section-title">ü•ó Generate Your Personalized Diet Plan</h2>

  <div class="card">
    <div class="section-heading">üë§ Your Body</div>
    
    <div class="input-row">
      <div class="input-group">
        <label for="age">Age</label>
        <input type="number" id="age" placeholder="Enter your age" min="1" max="120" />
      </div>
      <div class="input-group">
        <label for="gender">Gender</label>
        <select id="gender">
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
      </div>
    </div>

    <div class="input-row">
      <div class="input-group">
        <label for="height">Height (cm)</label>
        <input type="number" id="height" placeholder="Enter height in cm" min="100" max="250" />
      </div>
      <div class="input-group">
        <label for="weight">Weight (kg)</label>
        <input type="number" id="weight" placeholder="Enter weight in kg" min="20" max="300" />
      </div>
    </div>

    <div class="input-row">
      <div class="input-group">
        <label for="activityLevel">Activity Level</label>
        <select id="activityLevel">
          <option value="Sedentary">Sedentary (Little to no exercise)</option>
          <option value="Lightly active">Lightly active (Exercise 1-3 days/week)</option>
          <option value="Moderately active" selected>Moderately active (Exercise 3-5 days/week)</option>
          <option value="Very active">Very active (Exercise 6-7 days/week)</option>
        </select>
      </div>
      <div class="input-group">
        <label for="goal">Goal</label>
        <select id="goal">
          <option value="Lose weight">Lose weight</option>
          <option value="Maintain weight" selected>Maintain weight</option>
          <option value="Gain muscle">Gain muscle</option>
          <option value="Maintain health">Maintain health</option>
        </select>
      </div>
    </div>

    <div class="section-heading">üçΩÔ∏è Your Lifestyle</div>
    
    <div class="input-row">
      <div class="input-group">
        <label for="dietType">Diet Type</label>
        <select id="dietType">
          <option value="Vegetarian" selected>Vegetarian</option>
          <option value="Vegan">Vegan</option>
          <option value="Non-vegetarian">Non-vegetarian</option>
          <option value="Keto">Keto</option>
          <option value="Paleo">Paleo</option>
        </select>
      </div>
      <div class="input-group">
        <label for="dietPeriod">Diet Period</label>
        <select id="dietPeriod">
          <option value="1 day">1 day</option>
          <option value="1 week" selected>1 week</option>
          <option value="1 month">1 month</option>
          <option value="3 months">3 months</option>
        </select>
      </div>
    </div>

    <div class="section-heading">üéØ Your Food Preferences</div>
    
    <div class="input-row">
      <div class="input-group">
        <label for="existingConditions">Existing Conditions</label>
        <input type="text" id="existingConditions" placeholder="Diabetes, Hypertension, PCOD/PCOS, Thyroid, etc. or 'none'" />
      </div>
      <div class="input-group">
        <label for="allergies">Allergies or Intolerances</label>
        <select id="allergies">
          <option value="None">None</option>
          <option value="Gluten">Gluten</option>
          <option value="Dairy">Dairy</option>
          <option value="Nuts">Nuts</option>
          <option value="Soy">Soy</option>
          <option value="Shellfish">Shellfish</option>
          <option value="Eggs">Eggs</option>
        </select>
      </div>
    </div>

    <div class="input-row">
      <div class="input-group">
        <label for="fitnessGoals">Medical or Fitness Goals</label>
        <select id="fitnessGoals">
          <option value="Muscle gain">Muscle gain</option>
          <option value="Fat loss">Fat loss</option>
          <option value="Improved energy" selected>Improved energy</option>
          <option value="Better digestion">Better digestion</option>
          <option value="Better sleep">Better sleep</option>
          <option value="Increased stamina">Increased stamina</option>
        </select>
      </div>
    </div>

    <button class="btn-primary" onclick="getDietPlan()">Generate Personalized Diet Plan</button>
  </div>

  <div id="dietPlanResult" class="diet-plan-box"></div>

  <div class="about-section">
    <h2>About Us</h2>
    <p>
      NutriLens is an AI-driven health platform that combines food recognition, nutrition, and personal wellness.
      We aim to empower people with informed dietary choices through smart automation and user-friendly tools.
    </p>
    <br />
    <a class="btn-about" href="/">Learn More</a>
  </div>

  <footer>
    Made with ‚ù§Ô∏è by Team NutriLens
  </footer>

  <script>
    function showLoading() {
      const resultBox = document.getElementById("dietPlanResult");
      resultBox.innerHTML = '<div class="loading"> ‚ü≥ Generating your personalized diet plan...</div>';
      resultBox.style.display = 'block';
    }

    function showError(message) {
      const resultBox = document.getElementById("dietPlanResult");
      resultBox.innerHTML = `<div class="error">‚ùå Error: ${message}</div>`;
      resultBox.style.display = 'block';
    }

    function formatDietPlan(dietPlanText) {
      // Extract profile line and format it specially
      let profileMatch = dietPlanText.match(/Profile:\s*(.+)/);
      let profileInfo = profileMatch ? profileMatch[1] : '';
      
      // Enhanced formatting with better structure
      let formatted = dietPlanText
        .replace(/üéØ PERSONALIZED DIET PLAN FOR (.+)/g, '<h2>üéØ PERSONALIZED DIET PLAN FOR $1</h2>')
        .replace(/Profile:\s*(.+)/g, '<div class="profile-info">$1</div>')
        .replace(/üìä DAILY NUTRITIONAL TARGET:/g, '<h3>üìä DAILY NUTRITIONAL TARGET:</h3>')
        .replace(/üçΩÔ∏è MEAL PLAN \((.+)\):/g, '<h3>üçΩÔ∏è MEAL PLAN ($1):</h3>')
        .replace(/üè• THERAPEUTIC FOODS FOR (.+)/g, '<h3>üè• THERAPEUTIC FOODS FOR $1</h3>')
        .replace(/üíß HYDRATION & SUPPLEMENTS:/g, '<h3>üíß HYDRATION & SUPPLEMENTS:</h3>')
        .replace(/‚ö†Ô∏è FOODS TO AVOID:/g, '<h3>‚ö†Ô∏è FOODS TO AVOID:</h3>')
        .replace(/üìù ADDITIONAL TIPS:/g, '<h3>üìù ADDITIONAL TIPS:</h3>')
        .replace(/(EARLY MORNING|BREAKFAST|MID-MORNING SNACK|LUNCH|EVENING SNACK|DINNER) \((.+)\):/g, '<h4>$1 ($2):</h4>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\* \*\*(.+?):\*\* (.+)/g, '<li><strong>$1:</strong> $2</li>')
        .replace(/\* (.+)/g, '<li>$1</li>')
        .replace(/‚Ä¢ (.+)/g, '<li>$1</li>')
        .replace(/(\n|^)([^<\n*‚Ä¢].+?)(\n|$)/g, '$1<p>$2</p>$3')
        .replace(/<li>/g, '<ul><li>')
        .replace(/<\/li>(\s*<p>|$)/g, '</li></ul>$1')
        .replace(/<\/ul>\s*<ul>/g, '')
        .replace(/<p>\s*<\/p>/g, '');
      
      return formatted;
    }

    function displayDietPlan(dietPlanText) {
      const resultBox = document.getElementById("dietPlanResult");
      const formatted = formatDietPlan(dietPlanText);
      resultBox.innerHTML = formatted;
      resultBox.style.display = 'block';
    }

    async function getDietPlan() {
      const age = document.getElementById("age").value;
      const gender = document.getElementById("gender").value;
      const height = document.getElementById("height").value;
      const weight = document.getElementById("weight").value;
      const activityLevel = document.getElementById("activityLevel").value;
      const goal = document.getElementById("goal").value;
      const dietType = document.getElementById("dietType").value;
      const dietPeriod = document.getElementById("dietPeriod").value;
      const existingConditions = document.getElementById("existingConditions").value || "none";
      const allergies = document.getElementById("allergies").value;
      const fitnessGoals = document.getElementById("fitnessGoals").value;

      if (!age || !height || !weight) {
        alert("Please fill in all required fields (Age, Height, Weight)!");
        return;
      }

      showLoading();

      try {
        const response = await fetch("/get_diet_plan", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json" 
          },
          body: JSON.stringify({ 
            age: age,
            gender: gender,
            height: height,
            weight: weight,
            activity_level: activityLevel,
            goal: goal,
            diet_type: dietType,
            diet_period: dietPeriod,
            existing_conditions: existingConditions,
            allergies: allergies,
            fitness_goals: fitnessGoals
          }),
        });
        
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();

        if (data.error) {
          showError(data.error);
          return;
        }

        if (data.diet_plan) {
          displayDietPlan(data.diet_plan);
        } else {
          showError("No diet plan generated. Please try again.");
        }
      } catch (error) {
        console.error("Error:", error);
        showError("An error occurred while generating your diet plan. Please try again.");
      }
    }

    document.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        getDietPlan();
      }
    });
  </script>

</body>
</html>